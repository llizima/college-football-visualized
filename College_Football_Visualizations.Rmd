---
title: "College_Football_Visualizations"
output: html_document
---
# Load necessary libraries and packages


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load packages
if (!require("httr")) install.packages("httr")
if (!require("jsonlite")) install.packages("jsonlite")
if (!require("tidyverse")) install.packages("tidyverse")


# Load libraries
library(ggplot2)
library(dplyr)
library(forcats)
library(cowplot)
library(ggrepel) 
library(tidyr)
library(plotly)
library(httr)
library(jsonlite)
library(scales)
library(tidyverse)
library(stringr)
library(RColorBrewer)


```





# Connect to API 
```{r}

# Get API key from .Renviron
api_key <- Sys.getenv("CFB_API_KEY")

```





# Load data 

## Overall team talent
```{r}

# API call to team talent composite
res <- GET(
  url = "https://api.collegefootballdata.com/talent",
  add_headers(Authorization = paste("Bearer", api_key))
)

# Parse the JSON response
talent_data <- fromJSON(content(res, as = "text"), flatten = TRUE)

# Preview
head(talent_data)



```


## SP +  advanced ratings
```{r}

# API call to team talent composite
res <- GET(
  url = "https://api.collegefootballdata.com/ratings/sp",
  query = list(year = 2024),  # Optional: filter by year
  add_headers(Authorization = paste("Bearer", api_key))
)

# Parse the JSON response
sp_data <- fromJSON(content(res, as = "text"), flatten = TRUE)

# Preview
head(sp_data)


```



## Coaching history
```{r}

# API call to team talent composite
res <- GET(
  url = "https://api.collegefootballdata.com/coaches",
  query = list(year = 2024),  # Optional: filter by year,
  add_headers(Authorization = paste("Bearer", api_key))
)

# Parse the JSON response
coach_data <- fromJSON(content(res, as = "text"), flatten = TRUE)

# Preview
head(coach_data)


```



## Betting lines
```{r}

# API call to team talent composite
res <- GET(
  url = "https://api.collegefootballdata.com/lines",
  query = list(year = 2024),  # Optional: filter by year,
  add_headers(Authorization = paste("Bearer", api_key))
)

# Parse the JSON response
line_data <- fromJSON(content(res, as = "text"), flatten = TRUE)

# Preview
head(line_data)


```



## Team recruiting ranks
```{r}

# API call to team talent composite
res <- GET(
  url = "https://api.collegefootballdata.com/recruiting/teams",
  query = list(year = 2024),
  add_headers(Authorization = paste("Bearer", api_key))
)

# Parse the JSON response
recruit_data <- fromJSON(content(res, as = "text"), flatten = TRUE)

# Preview
head(recruit_data)


```


## Returning player production
```{r}

# API call to team talent composite
res <- GET(
  url = "https://api.collegefootballdata.com/player/returning",
  query = list(year = 2024),
  add_headers(Authorization = paste("Bearer", api_key))
)

# Parse the JSON response
exp_data <- fromJSON(content(res, as = "text"), flatten = TRUE)

# Preview
head(exp_data)


```


# A chart that shows the distribution of a single categorical variable

## Distribution of college football conferences for 2024 season

```{r}

# Inspect data
glimpse(sp_data)
glimpse(recruit_data)
glimpse(coach_data)
glimpse(talent_data)
glimpse(exp_data)

# Sort conferences by frequency
sp_df <- sp_data %>%
  filter(!is.na(conference)) %>%
  mutate(conference = as.factor(conference)) %>% 
  mutate(conference = fct_lump(conference, n=9)) %>%
  count(conference, sort = TRUE)


# Bar chart

# Create a palette
text_palette <- colorRampPalette(c("darkgray", "darkorange"))

sp_df <- sp_df %>%
  mutate(
    rank = row_number(),
    skip_color = rank > (n() - 2),
    alt_index = rank %% 2 == 1,
    text_color = ifelse(
  skip_color, 
  "transparent",  # hide labels for last 2
  ifelse(rank %in% c(1, 2, 3, 5, 7),  # always show for given ranks
         text_palette(n())[rank],
         "transparent")  # hide for everything else

    )
  )


p <- ggplot(data = sp_df, aes(x = fct_reorder(conference, n), y = n, fill = n)) + geom_col(show.legend = FALSE) +
  geom_text(aes(label = n, color = text_color),
            hjust = 1.1,
            size = 4,
            show.legend = FALSE) +
  scale_color_identity() +
  coord_flip() + scale_fill_gradient(low = "lightblue", high = "darkblue") + labs(
    title = "Number of Teams by College Football Conference",
    subtitle = "2024-25 Season",
    x = NULL,
    y = "Number of Teams",
    fill = "Count"
  ) + theme_minimal()
  
p
  
```


### Interpretation of distribution of a single categorical variable:

This bar chart displays the distribution of the number of teams across college football conferences for the 2024–25 season. The center of the distribution, or mode, falls within the 12 to 16 team range, which includes the majority of conferences. The maximum is 18 teams, found in the Big Ten, which has expanded significantly. At the other end, the minimum is 2 teams, seen in both the Pac-12 (which effectively dissolved) and the FBS Independents.

The range of team counts spans from 2 to 18, indicating a relatively wide spread in the number of teams per conference. The Big Ten could be considered an informal high-count outlier, while the Pac-12 and Independents may represent low-count outliers, especially since most conferences have at least 10 teams.

It’s also notable that the last two national champions—Michigan (2023–24) and Ohio State (2024–25)—both come from the Big Ten. Among the Power Five conferences, the four with the highest team counts are all represented—except the Pac-12, which dissolved before the season. This reflects major realignment trends and a growing concentration of teams in a few dominant conferences.





# A chart that shows the distribution of a single quantitative variable
## Distribution of offensive efficiency for College Football Conferences from the 2024-25 season

```{r}

# Filter out NA
big10_df <- exp_data %>%
  filter(!is.na(conference) )

# Inspect data Frame
glimpse(big10_df)


# chart

x_limits <- range(big10_df$percentPPA, na.rm = TRUE)
binwidth_percent <- (max(big10_df$percentPPA, na.rm = TRUE) - min(big10_df$percentPPA, na.rm = TRUE)) / 15
median_val <- median(big10_df$percentPPA, na.rm = TRUE)

hist_p <- ggplot(big10_df, aes(x =  percentPPA)) +
  geom_histogram(binwidth = binwidth_percent, center = 0,
                 color = "darkgray", fill = "lightblue") +
  stat_function(fun = function(x) {
    dnorm(x, mean = mean(big10_df$percentPPA, na.rm = TRUE),
              sd = sd(big10_df$percentPPA, na.rm = TRUE)) * nrow(big10_df) * binwidth_percent},  
    aes(color = "Normal"), size = 1.2) +
  geom_density(aes(y = ..density.. * nrow(big10_df) * binwidth_percent, color = "Empirical"), 
               adjust = 1.5, size = 1.2, fill = NA) +
  scale_color_manual(name = "Density:", 
                     values = c("Normal" = "red", "Empirical" = "blue")) +
  labs( title = "Distribution of Offensive Efficiency for College Football Teams",  subtitle = "2024-25 Season",
        x = "percentPPA",y = "Count" ) + coord_cartesian(xlim = x_limits) + 
  theme_minimal()


box_p <- ggplot(big10_df, aes(x = percentPPA, y = factor(1))) +
  geom_boxplot(fill = "lightblue", width = 0.4, outlier.color = "black") +
   geom_text(aes(x = median_val, y = 1, label = paste0("Median = ", round(median_val, 2))),
            vjust = -0.000001, size = 4, color = "black") +  
  coord_cartesian(xlim = x_limits) +
  theme_minimal() +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    plot.margin = margin(t = -15)  # reduce white space between plots
  ) +
  labs(y = NULL, x = NULL)

final_p <- plot_grid(hist_p, box_p, 
                     ncol = 1, 
                     align = "v",       # align vertically
                     rel_heights = c(3, 0.5))

final_p
  
```

### Interpretation of a chart that shows chart that shows the distribution of a single quantitative variable

This plot shows the distribution of offensive efficiency scores for college football teams during the 2024–25 season, measured by Percent PPA (Predicted Points Added). The values range from 0 to 1, where a higher score indicates better offensive performance. Percent PPA reflects how efficiently a team converts scoring opportunities—higher values represent greater success in capitalizing on those chances.

The distribution is approximately normal, though the empirical curve appears slightly flatter than a standard bell curve, with thicker tails. This suggests there may be more variability at the extremes than expected in a true normal distribution.

The median Percent PPA score is 0.47, meaning that half of the teams scored below this value and half scored above. The minimum observed score is 2.5% (0.025), and the maximum is 92.5% (0.925), showing a wide range of offensive efficiency across teams. The majority of teams fall between approximately 20% and 62%, with only three teams scoring below 13%, making that range the least frequent.

No formal outliers were identified using the IQR method, but the very low end of the distribution (under 13%) represents a small subset of underperforming offenses.







# A chart that shows the distribution of two categorical variables
## Distribution of Team Ranking by College Football Conferences from the 2024-25 season

```{r}


# Step 1: Define top conferences explicitly
top_confs <- c(
  "SEC", "Big Ten", "ACC", "Pac-12", "Big 12",
  "American Athletic", "Mountain West", "Conference USA", 
  "FBS Independents", "Mid-American", "Sun Belt"
)

# Step 2: Clean and categorize data
df_clean <- sp_data %>%
  filter(!is.na(ranking), !is.na(conference)) %>%
  mutate(
    conference = str_squish(str_trim(conference)),
    
    #  Standardize known names
    conference = case_when(
      str_detect(conference, regex("Mountain", ignore_case = TRUE)) ~ "Mountain West",
      str_detect(conference, regex("SEC", ignore_case = TRUE)) ~ "SEC",
      str_detect(conference, regex("Big Ten", ignore_case = TRUE)) ~ "Big Ten",
      str_detect(conference, regex("ACC", ignore_case = TRUE)) ~ "ACC",
      str_detect(conference, regex("Pac", ignore_case = TRUE)) ~ "Pac-12",
      str_detect(conference, regex("Big 12", ignore_case = TRUE)) ~ "Big 12",
      str_detect(conference, regex("American", ignore_case = TRUE)) ~ "American Athletic",
      str_detect(conference, regex("Conference USA", ignore_case = TRUE)) ~ "Conference USA",
      str_detect(conference, regex("Independent", ignore_case = TRUE)) ~ "FBS Independents",
      str_detect(conference, regex("Mid-American", ignore_case = TRUE)) ~ "Mid-American",
      str_detect(conference, regex("Sun Belt", ignore_case = TRUE)) ~ "Sun Belt",
      TRUE ~ "Non-Top Conference"   # ✅ label for all other conferences
    ),
    
    #  Collapse into top or non-top conferences
    conference = ifelse(conference %in% top_confs, conference, "Non-Top Conference"),
    
    # Define ranking groups
    ranking_group = case_when(
      ranking >= 1 & ranking <= 5 ~ "1-5",
      ranking >= 6 & ranking <= 10 ~ "6-10",
      ranking >= 11 & ranking <= 15 ~ "11-15",
      ranking > 15 ~ "Outside Top 15"
    ),
    ranking_group = factor(ranking_group, levels = c("1-5", "6-10", "11-15", "Outside Top 15"))
  )

# Step 3: Summarize for plotting
df_plot <- df_clean %>%
  group_by(ranking_group, conference) %>%
  summarise(
    count = n(),
    teams = paste(team, collapse = "<br>"),
    .groups = "drop"
  ) %>%
  group_by(ranking_group) %>%
  mutate(
    percent = 100 * count / sum(count)
  ) %>%
  arrange(ranking_group, desc(percent)) %>%
  ungroup()

# Step 4: Distinct color map
color_map <- c(
  "SEC" = "#E69F00",
  "Big Ten" = "#56B4E9",
  "ACC" = "darkgreen",
  "Pac-12" = "purple",
  "Big 12" = "#D55E00",
  "American Athletic" = "lightpink",
  "Mountain West" = "#999999",
  "Conference USA" = "#66C2A5",
  "FBS Independents" = "#000000",
  "Mid-American" = "#A52A2A",
  "Sun Belt" = "#20B2AA",
  "Non-Top Conference" = "gray40"  # ✅ for grouped others
)

# Step 5: Build plotly stacked bar chart
p_plotly <- plot_ly()
ranking_levels <- levels(df_clean$ranking_group)
used_legends <- c()

for (grp in ranking_levels) {
  df_grp <- df_plot %>%
    filter(ranking_group == grp) %>%
    arrange(percent)  # ensures tallest stack appears on top
  
  for (i in 1:nrow(df_grp)) {
    row <- df_grp[i, ]
    show_legend <- !(row$conference %in% used_legends)
    used_legends <- c(used_legends, row$conference)
    
    p_plotly <- add_trace(
      p_plotly,
      x = row$ranking_group,
      y = row$percent,
      name = row$conference,
      type = 'bar',
      marker = list(color = color_map[[row$conference]]),
      text = paste0(
        "<b>Conference:</b> ", row$conference,
        "<br><b>Percent:</b> ", round(row$percent, 1), "%",
        "<br><b>Teams:</b><br>", row$teams
      ),
      hoverinfo = "text",
      textposition = "none",
      showlegend = show_legend,
      legendgroup = row$conference
    )
  }
}

# Step 6: Layout
p_plotly <- layout(
  p_plotly,
  barmode = "stack",
  title = list(
    text = "<b>Top 15 Ranking Distribution by Conference</b><br><span style='font-size:12pt;'>2024–2025 Season</span>",
    x = 0.5
  ),
  xaxis = list(title = "Ranking Group", categoryorder = "array", categoryarray = ranking_levels),
  yaxis = list(title = "Percent (%)"),
  legend = list(title = list(text = "<b>Conference</b>")),
  margin = list(t = 80)
)

p_plotly




```


### Interpretation of a chart that shows chart that shows the distribution of two categorical variables
This chart displays the distribution of college football team rankings by conference for the 2024–25 season, grouped into four categories: ranks 1–5, 6–10, 11–15, and Outside Top 15. Among the top five teams, 60% are from the Big Ten and 40% from the SEC, indicating a concentration of top rankings within two conferences. The SEC also dominates the 6–15 range, representing about 60% of those ranked teams, while the ACC and FBS Independents make up the rest.

The majority of teams—119 out of 139—fall outside the Top 15, demonstrating a highly uneven distribution of top rankings across conferences. This suggests that only a small subset of Power Five programs consistently reach elite status, while most other teams are not nationally ranked. Notably, no Group of Five teams appear in the Top 15, reinforcing the competitive gap between the Power Five and other FBS conferences. The Pac-12, a former Power Five conference, is absent due to its dissolution, which further reshapes the national competitive landscape.







# A chart that shows the distribution of a quantitative variable across categories of a categorical variable
## Distribution of offense.ranking across the categories of conference by College Football Conferences from the 2024-25 season
```{r}


sp_data
glimpse(sp_data)

# Filter and clean offense.ranking and conference
df_box <- sp_data %>%
  filter(!is.na(offense.ranking), !is.na(conference)) %>%
  mutate(conference = str_squish(str_trim(conference)))  # Clean up spaces

df_box <- df_box %>% mutate(conference = fct_lump(factor(conference), n = 5))


# Create boxplot
Pbox <- ggplot(data = df_box, aes(x = conference, y = offense.ranking, fill = conference)) +
  geom_boxplot() +
  labs(
    x = "",
    y = "Offensive Ranking",
    title = "Distribution of Offensive Rankings by Conference"
  ) +
  theme_minimal() +
  theme(
    axis.text.x  = element_text(face = "bold", size = 10, angle = 45, hjust = 1),
    axis.title.y = element_text(face = "bold", size = 14),
    plot.title   = element_text(hjust = 0.5, face = "bold")
  ) +
  scale_fill_viridis_d(option = "plasma") +
  scale_y_reverse(expand = expansion(mult = c(0, 0.1))) +  # Optional: lower rankings are better
  theme(legend.position = "none")

Pbox


```

### Interpretation of a chart that shows the distribution of a quantitative variable across categories of a categorical variable
This chart shows the distribution of offensive rankings (lower values = better performance) across college football conferences for the 2024–25 season. The y-axis is inverted, so rankings closer to the top of the chart indicate better-performing offenses.

The SEC has the highest (best) median offensive ranking, followed by the Big 12. However, the Big 12 includes a notable outlier ranked well outside the top 100, pulling the overall spread wider. The median offensive rankings across all conferences range from roughly 25 to 100.

The SEC, Big 12, and American Athletic Conference all have median lines higher on the chart, indicating that most of their teams performed better offensively. Their boxplots also show a longer tail toward the bottom, meaning there are a few lower-performing teams dragging down the average. This pattern suggests a right-skewed distribution, where the median is better than the mean.

In contrast, conferences like the Big Ten and Sun Belt have their medians lower on the chart, suggesting that more teams in those conferences had weaker offensive rankings, but with some standout teams performing much better than the rest. This shape indicates left-skewness, where a few very strong teams improve the average, even though most teams underperformed.

The ACC appears more balanced, with the median line roughly centered in the box and no clear skew, suggesting a more symmetrical distribution of offensive rankings among its teams.







# A chart that shows the relationship between two quantitative variables
## Scatter plot of defense.rating and ranking across the categories of conference by College Football Conferences from the 2024-25 season
```{r}

# Filter and select relevant variables
df_def <- sp_data %>%
  filter(!is.na(defense.rating), !is.na(ranking)) %>%
  select(team, ranking, defense.rating, offense.ranking, conference)

# Calculate IQR-based outlier bounds
Q1_def <- quantile(df_def$defense.rating, 0.25)
Q3_def <- quantile(df_def$defense.rating, 0.75)
IQR_def <- Q3_def - Q1_def
lb_def <- Q1_def - 1.5 * IQR_def
ub_def <- Q3_def + 1.5 * IQR_def

Q1_rank <- quantile(df_def$ranking, 0.25)
Q3_rank <- quantile(df_def$ranking, 0.75)
IQR_rank <- Q3_rank - Q1_rank
lb_rank <- Q1_rank - 1.5 * IQR_rank
ub_rank <- Q3_rank + 1.5 * IQR_rank

# Label outliers (optional — not used for coloring here)
df_def <- df_def %>%
  mutate(outlier_status = ifelse(
    (defense.rating < lb_def | defense.rating > ub_def) |
    (ranking < lb_rank | ranking > ub_rank),
    "Outlier", "Normal"
  ))

# Create interactive plot colored by conference
p_plotly <- plot_ly(
  data = df_def,
  x = ~ranking,
  y = ~defense.rating,
  type = 'scatter',
  mode = 'markers',
  color = ~conference,  
  text = ~paste(
    "<b>Team:</b>", team,
    "<br><b>Conference:</b>", conference,
    "<br><b>Offense Ranking:</b>", offense.ranking,
    "<br><b>Defense Rating:</b>", round(defense.rating, 2),
    "<br><b>Overall Ranking:</b>", ranking
  ),
  hoverinfo = 'text',
  marker = list(size = 10, opacity = 0.8, line = list(width = 1, color = '#333'))
) %>%
  layout(
    title = list(
      text = "<b>Defense Rating vs Overall Ranking</b><br><span style='font-size:12pt;'>2024–2025 Season</span>",
      x = 0.5,
      xanchor = "center"
    ),
    margin = list(t = 80),
    xaxis = list(title = "Overall Ranking"),
    yaxis = list(title = "Defense Rating"),
    legend = list(title = list(text = "<b>Conference</b>"))  # updated legend title
  )

# Show plot
p_plotly





```

### Interpretation of a chart that shows the relationship between two quantitative variables

This scatter plot displays the relationship between defense rating and team ranking across college football conferences for the 2024–25 season. The defense rating ranges from approximately 9.2 to 43.8, while ranking spans from 1 (best) to 134 (worst).

There is a clear positive linear association between defense rating and ranking. As a team's defense rating increases (i.e., their defense performs worse), their ranking number also increases (meaning their overall team ranking worsens). This suggests that stronger defenses (lower ratings) are associated with better team performance and lower (more favorable) rankings. The pattern supports the idea that defensive efficiency plays a key role in overall team success.









# A chart that shows the relationship between two quantitative variables and a categorical variable
## Radar/Spider Chart to display the mean rankings and special teams rating by conference

```{r}

glimpse(sp_data)



# Prepare data
radar_df <- sp_data %>%
  filter(!is.na(conference), 
         !is.na(offense.ranking), 
         !is.na(defense.ranking), 
         !is.na(specialTeams.rating)) %>%
  group_by(conference) %>%
  summarise(
    Offense = mean(offense.ranking, na.rm = TRUE),
    Defense = mean(defense.ranking, na.rm = TRUE),
    SpecialTeams = mean(specialTeams.rating, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Normalize values to [0,1] for fair comparison
  mutate(
    Offense = scales::rescale(Offense, to = c(0, 1)),
    Defense = scales::rescale(Defense, to = c(0, 1)),
    SpecialTeams = scales::rescale(SpecialTeams, to = c(0, 1))
  ) %>%
  pivot_longer(cols = -conference, names_to = "Metric", values_to = "Value")

# Unique conferences
conference_levels <- unique(radar_df$conference)

# Generate a color palette with as many distinct colors as conferences
num_colors <- length(conference_levels)
colors <- RColorBrewer::brewer.pal(min(num_colors, 8), "Set2")
if (num_colors > 8) {
  # extend colors using distinct hue palette if needed
  colors <- colorspace::rainbow_hcl(num_colors)
}
names(colors) <- conference_levels

# Create plot
radar_plot <- plot_ly(type = 'scatterpolar', fill = 'toself')

for (conf in conference_levels) {
  radar_plot <- radar_plot %>%
    add_trace(
      r = radar_df$Value[radar_df$conference == conf],
      theta = radar_df$Metric[radar_df$conference == conf],
      name = conf,
      line = list(color = colors[conf]),
      fillcolor = colors[conf],
      opacity = 0.5
    )
}

radar_plot <- radar_plot %>%
  layout(
    title = list(
      text = "<b>Average Rankings & Special Teams Ratings by Conference</b><br><span style='font-size:12pt;'>2024–2025 Season</span>",
      x = 0.5,
      xanchor = "center"
    ),
    margin = list(t = 80),
    polar = list(
      radialaxis = list(
        visible = TRUE,
        range = c(0, 1),
        tickfont = list(size = 10)
      )
    ),
    legend = list(
      orientation = "h",
      x = 0.5,
      xanchor = "center",
      y = -0.2,
      font = list(size = 11)
    )
  )

radar_plot





```


### Interpretation of a chart that shows the relationship between two quantitative variables and a categorical variable

This radar chart displays the mean offensive rating, defensive rating, and special teams rating for each college football conference in the 2024–25 season. In this chart, lower values indicate stronger performance for offense and defense, while higher values represent stronger performance for special teams. Since the radar chart maintains raw scale across all three metrics, the ideal conference would appear closer to the center for offense and defense ratings, but farther out on the special teams axis.

The SEC appears to be one of the most balanced and high-performing conferences, with low (strong) average offensive and defensive ratings, and above-average special teams performance. The Big Ten and ACC also perform relatively well on offense and defense, though they are more moderate in special teams. In contrast, Group of Five conferences such as Conference USA and the Sun Belt tend to have higher (weaker) offensive and defensive ratings, though some may show stronger special teams ratings.
